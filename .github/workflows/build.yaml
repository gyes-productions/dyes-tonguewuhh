---
name: Build VST

# TODO - extract this workflow into something reusable.  Use it in Fluffy Drums as well
on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Select platform to build'
        required: true
        default: 'both'
        type: choice
        options:
          - both
          - macos
          - windows

concurrency:
  group: build
  cancel-in-progress: true

jobs:
  build-macos:
    if: ${{ github.event.inputs.platform == 'both' || github.event.inputs.platform == 'macos' }}
    runs-on: macos-latest
    # runs-on: macos-latest-large
    env:
      RELEASE_MODE: "CI"
      JUCE_BRANCH: "juce6"
    steps:
      - name: Checkout HISE repository
        uses: actions/checkout@v6
        with:
          repository: eschirle/HISE
          ref: 'develop'
          clean: true
          submodules: false
          path: HISE

      - name: Checkout JUCE submodules
        run: |
          cd HISE
          git submodule update --init --recursive
          cd JUCE
          git checkout ${{ env.JUCE_BRANCH }}

      # TODO: Investigate caching so we don't have to build HISE binary every time
      - name: Build HISE
        working-directory: ${{ github.workspace }}/HISE/tools/auto_build/
        run: |
          # Unzip SDK
          unzip -o ${{ github.workspace }}/HISE/tools/SDK/sdk.zip -d ${{ github.workspace }}/HISE/tools/SDK/
          
          sh ./build_ci.sh "${{ env.RELEASE_MODE }}" --skip-tests-and-export
          
          # cd ${{ github.workspace }}/HISE/projects/standalone/Builds/MacOSX
          # xcodebuild -project "HISE Standalone.xcodeproj" -configuration Release -jobs 4 | xcpretty
          # set -o pipefail && xcodebuild -project "HISE Standalone.xcodeproj" -configuration "${{ env.RELEASE_MODE }}" | ./tools/Projucer/xcbeautify --renderer github-actions

      - name: Checkout Current Repository
        uses: actions/checkout@v6
        with:
          path: app
      
      # Copy everything from app folder to root
      - name: Copy app folder to root
        run: |
          cp -R ${{ github.workspace }}/app/* ${{ github.workspace }}/

      - name: Build Plugin
        run: |
          sh ./build.sh

      # TODO: Create a release on the repo and upload files there
      - name: Copy VST3 to root
        run: |
          cp Binaries/Builds/MacOSX/build/Release/*.vst3 ${{ github.workspace }}/

      - name: Upload Dyes Tonguewuhh
        uses: actions/upload-artifact@v6
        with:
          name: dyes-tonguewuhh-macos
          path: |
            *.hr1
            *.vst3

  build-windows:
    if: ${{ github.event.inputs.platform == 'both' || github.event.inputs.platform == 'windows' }}
    runs-on: windows-latest
    env:
      RELEASE_MODE: "CI"
      JUCE_BRANCH: "juce6"
    steps:
      # TODO: Is this cleanup step needed?
      - name: Cleanup working dir (?)
        run: del *.* /Q /S
        shell: cmd

      - name: Checkout HISE repository
        uses: actions/checkout@v6
        with:
          repository: eschirle/HISE
          ref: 'develop'
          clean: true
          submodules: false
          path: HISE

      - name: Checkout JUCE submodules
        shell: cmd
        run: |
          cd HISE
          git submodule update --init --recursive
          cd JUCE
          git checkout ${{ env.JUCE_BRANCH }}

      - name: Setup Intel oneAPI
        uses: rscohn2/setup-oneapi@v0
        with:
          components: |
            ipp

      - name: Setup MSBuild and VS Dev Environment
        uses: microsoft/setup-msbuild@v2
        with:
          #vs-prerelease: true # This did not include v145
          msbuild-architecture: x64
          
      - name: Build HISE CI
        working-directory: ${{ github.workspace }}/HISE/tools/auto_build/
        shell: cmd
        run: |
          chdir
          dir
          build_ci.bat "${{ env.RELEASE_MODE }}" --skip-tests-and-export

      - name: Checkout Current Repository
        uses: actions/checkout@v6
        with:
          path: app

      - name: Copy app folder to root
        run: Copy-Item -Path "${{ github.workspace }}/app/*" -Destination "${{ github.workspace }}" -Recurse -Force
        shell: pwsh

      - name: Build Plugin
        shell: cmd
        run: build.bat

      - name: Copy VST3 to root
        shell: pwsh
        run: Copy-Item -Path "${{ github.workspace }}/Binaries/Builds/Windows/build/Release/*.vst3" -Destination "${{ github.workspace }}" -Recurse -Force

      - name: Upload Dyes Tonguewuhh
        uses: actions/upload-artifact@v6
        with:
          name: dyes-tonguewuhh-windows
          path: |
            *.hr1
            *.vst3
